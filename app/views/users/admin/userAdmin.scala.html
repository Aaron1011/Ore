@import db.ModelService
@import db.impl.access.{UserBase, ProjectBase, OrganizationBase}
@import models.user.User
@import models.user.role.{OrganizationRole, ProjectRole, RoleModel}
@import ore.permission.role.{RoleTypes, GlobalRole}
@import ore.{OreConfig, OreEnv}

@(user: User)(implicit messages: Messages, request: Request[_], service: ModelService,
        config: OreConfig, users: UserBase, projects: ProjectBase, organizations: OrganizationBase)

@isOrg = @{user.isOrganization}

@orgRoles = @{RoleTypes.values.filter(r => r.roleClass == classOf[OrganizationRole] && r.roleId != 64)}
@projectRoles = @{RoleTypes.values.filter(_.roleClass == classOf[ProjectRole])}
@globalRoles = @{RoleTypes.values.filter(_.roleClass == classOf[GlobalRole])}


@panel(title: String, size: Int = 9)(content: Html) = {
    <div class="col-md-@size">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">@title</h4>
            </div>
            @content
        </div>
    </div>
}

@roleTable[M <: RoleModel](keyName: String, roles: Set[M], roleTypes: Set[RoleTypes.Value])(showKey: M => Html) = {
    <table class="table">
        <tr><th>@keyName</th><th>Role</th><th>Accepted</th></tr>
        @for(role <- roles) {
        <tr>
            <td>@showKey(role)</td>
            <td><select>
                @for(roleType <- roleTypes) {
                    <option @if(role.roleType == roleType) {selected}>@roleType.title</option>
                }
            </select></td>
            <td><input type="checkbox" @if(role.isAccepted) {checked}></td>
            <td><a href="#"><i class="fa fa-trash"></i></a></td>
        </tr>
        }
        <tr>
            <td colspan="3">
                <button data-toggle="modal" data-target="#new-page" title="Add" class="btn yellow btn-sm">
                        <i class="fa fa-plus"></i>
                </button>
            </td>
        </tr>
    </table>
}

@bootstrap.layout((if(isOrg) "Organization" else "User") + " Admin - " + user.username) {

    <div class="container" style="margin-top: 90px;">
        <div class="row">
            <div class="col-md-12">
                <h1>@{(if(isOrg) "Organization" else "User") + " Admin - "}<a href="@routes.Users.showProjects(user.username, None)">@user.username</a></h1>
            </div>
        </div>

        <div class="row">
            @if(!isOrg) {
                @panel("Organizations") {
                    @roleTable("Organization", user.organizationRoles.all, orgRoles) { role =>
                        <a href="@routes.Application.userAdmin(role.organization.username)">
                            @role.organization.username
                        </a>
                    }
                }
            } else {
                @panel("Members") {
                    @roleTable("User", user.toOrganization.memberships.roles.all, orgRoles) { role =>
                        <a href="@routes.Application.userAdmin(role.user.username)">
                            @role.user.username
                        </a>
                    }
                }
            }
            @panel("Other Administration", size=3) {
                <div class="list-group">
                    <div class="list-group-item">
                        <a href="@config.security.getString("api.url").get/admin/accounts/user/@user.id/change/">SpongeAuth Admin</a>
                    </div>
                    <div class="list-group-item">
                        <a href="https://forums.spongepowered.org/users/@user.username">Forum Profile</a>
                    </div>
                </div>
            }
        </div>
        @if(!isOrg) {
        <div class="row">
            @panel("Projects") {
                @roleTable("Project", user.projectRoles.all, projectRoles) { role =>
                    <a href="@controllers.project.routes.Projects.show(role.project.ownerName, role.project.slug)">
                        @role.project.name
                    </a>
                }
            }
        </div>
        }
        <div class="row">
            @panel("Global Roles") {
                <div class="list-group">
                @for(role <- user.globalRoles) {
                    <div class="list-group-item">
                        @role.title
                        <span class="pull-right">
                            <a href="#"><i class="fa fa-trash"></i></a>
                        </span>
                    </div>
                }
                    <div class="list-group-item">
                        <select>
                        @for(roleType <- globalRoles) {
                            <option>@roleType.title</option>
                        }
                        </select>
                        <button title="Add" class="btn yellow btn-sm">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>

}
