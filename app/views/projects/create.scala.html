@*
Page used for uploading and creating new projects.
*@
@import controllers.project.routes.{Projects => projectRoutes}
@import models.project.Project
@import models.project.Project.PendingProject
@import views.html.helper.form
@(pending: Option[PendingProject])(implicit messages: Messages, session: Session, flash: Flash, request: RequestHeader)

@core.layout(messages("project.create")) {

    <script type="text/javascript" src="@routes.Assets.at("javascripts/projectCreateValidate.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("javascripts/pluginUpload.js")"></script>

    <div class="container" style="margin-top: 90px">
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="panel panel-default panel-create">
                    <div class="panel-heading">
                        <h3 class="panel-title">@messages("project.create.title")
                            @defining(if (pending.isEmpty) 1 else 2) { step =>
                                <span class="pull-right minor">@messages("project.create.step", step, 3)</span>
                            }
                        </h3>
                    </div>
                    <div class="project-body panel-body">
                        <div class="minor create-blurb">
                            <p>@Html(messages("project.create.info-text.head"))</p>
                            <p>@Html(messages("project.create.info-text.bottom"))</p>
                        </div>

                        @if(flash.get("error").isDefined) {
                            <div class="alert alert-danger alert-dismissable" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="@messages("aria.close")">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <strong>@messages("project.create.error")</strong> @flash.get("error").get
                            </div>
                        }

                        @if(pending.isDefined) {
                            @* Display plugin metadata *@
                            @defining(pending.get.project) { project =>
                                <div class="plugin-meta">
                                    <table class="plugin-meta-table">
                                        <tbody>
                                            <tr>
                                                <td><strong>@messages("project.create.uid")</strong></td>
                                                <td>@project.pluginId <i class="id-status fa fa-spinner fa-spin"></i></td>
                                            </tr>
                                            <tr>
                                                <td><strong>@messages("project.name")</strong></td>
                                                <td>@project.name <i class="name-status fa fa-spinner fa-spin"></i></td>
                                            </tr>
                                            <tr>
                                                <td><strong>@messages("project.owner")</strong></td>
                                                <td>@project.ownerName</td>
                                            </tr>
                                            <tr>
                                                <td><label for="description">Description</label></td>
                                                <td>
                                                    @defining(pending.get.pendingVersion.get.version.description) { description =>
                                                        <input form="continue" class="form-control" type="text" id="description"
                                                               name="description" maxlength="@Project.MaxDescriptionLength"
                                                            @description.map { value =>
                                                              value="@value"
                                                            }.getOrElse {
                                                              placeholder="@messages("version.create.no-description")"
                                                            }
                                                        />
                                                    }
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <script>
                                    $(function() {
                                        validateMeta("@project.pluginId", "@project.name",
                                                     "@project.ownerName", "@project.slug");
                                    });
                                    </script>
                                </div>
                            }
                        }

                        @if(pending.isDefined) {
                            @* Category select *@
                            @projects.inputSettings("continue")
                        }

                        <div class="create-buttons">
                            @* File controls *@
                            @form(action = projectRoutes.upload, 'enctype -> "multipart/form-data", 'id -> "form-upload") {
                                <label class="btn btn-default pull-left" for="pluginFile">
                                    <input id="pluginFile" name="pluginFile" type="file" style="display: none;">
                                    @messages("project.create.select-file")
                                </label>
                            }

                            @* Continue to next step *@
                            @if(pending.isDefined) {
                                @defining(pending.get.project) { project =>
                                    @form(action = projectRoutes.showFirstVersionCreator(project.ownerName, project.slug),
                                        'id -> "continue", 'class -> "pull-right") {

                                        <div class="btn-group">
                                            <a href="@projectRoutes.showCreator" title="Back" class="pull-left btn btn-default">
                                                <i class="fa fa-arrow-left"></i>
                                            </a>

                                            @* Disabled until JS determines meta is valid *@
                                            <button title="Continue" type="submit" name="create" value="@messages("project.create.continue")"
                                                    class="pull-right continue-btn btn btn-default" disabled>
                                                <i class="fa fa-spinner fa-spin"></i>
                                            </button>
                                        </div>
                                    }
                                }
                            }

                            @projects.alertFile()
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

}
